-- Backfill password_reset_email_log with all emails that were sent via Resend
-- This prevents duplicate emails from being sent

-- First, we need to insert records for emails that were successfully sent
-- We'll use a placeholder user_id since we don't have the mapping readily available
-- The email address is what matters for deduplication

-- Get unique emails that received the password reset (excluding duplicates)
-- These are emails that had subject "Welcome to Our New Website - Set Your Password"

INSERT INTO public.password_reset_email_log (user_id, email, status, sent_at)
SELECT 
  COALESCE(
    (SELECT id FROM auth.users WHERE email = emails.email_address LIMIT 1),
    '00000000-0000-0000-0000-000000000000'::uuid
  ) as user_id,
  emails.email_address,
  'sent',
  NOW()
FROM (
  SELECT DISTINCT LOWER(email_address) as email_address
  FROM (VALUES
    ('j22pr@hotmail.com'),
    ('t.webber08@outlook.com'),
    ('mikkumatysik45@gmail.com'),
    ('edward@regentlet.co.uk'),
    ('tommylad2008@hotmail.com'),
    ('laurenwarne@icloud.com'),
    ('jared.tm@outlook.com'),
    ('izaacbutchers024@gmail.com'),
    ('hannah.marrion@hotmail.com'),
    ('raycewest@outlook.com'),
    ('s.carswell@yahoo.co.uk'),
    ('marybridget28@outlook.com'),
    ('jovanedesigns@gmail.com'),
    ('cheekycherylis@hotmail.com'),
    ('marianapereiraoliveira5@gmail.com'),
    ('emilybcocker@gmail.com'),
    ('nicole.davies86@hotmail.com'),
    ('domniki_vg@yahoo.com'),
    ('djgarphie@gmail.com'),
    ('alexmc84@googlemail.com'),
    ('campbell1905@hotmail.co.uk'),
    ('sophiepollardg@hotmail.com'),
    ('sspencerwilkss@gmail.com'),
    ('jeff999@btinternet.com'),
    ('pghirst99@gmail.com'),
    ('mac.hill2001@gmail.com'),
    ('samshowering@hotmail.co.uk'),
    ('zflawrence@gmail.com'),
    ('a_cobbold@yahoo.com'),
    ('mrholden91@gmail.com'),
    ('ellieabraham@live.co.uk'),
    ('rossco90@hotmail.co.uk'),
    ('aaron.robert.foot@hotmail.co.uk'),
    ('frampton_paul@me.com'),
    ('mgmt.laskham@beunscripted.co.uk'),
    ('rob98242@gmail.com'),
    ('millie.melanaphy@yahoo.com'),
    ('richardjmcintyre13@gmail.com'),
    ('r.mcgowan024@outlook.com'),
    ('jbargrove@hotmail.co.uk'),
    ('sam_dale@hotmail.com'),
    ('millieroseappleton@outlook.com'),
    ('kieron.glenn.hall@gmail.com'),
    ('ratcliffe.nicky@yahoo.com'),
    ('katysawdon@icloud.com'),
    ('lloyd.coxall123@gmail.com'),
    ('clarke197@yahoo.co.uk'),
    ('sidmiles332@gmail.com'),
    ('hello@hughesadvisory.com'),
    ('lydia@test.io'),
    ('krystigalpin@gmail.com'),
    ('camilleryall@hotmail.co.uk'),
    ('jodiemapes42@gmail.com'),
    ('caseybecca@icloud.com'),
    ('sherwood2908@gmail.com'),
    ('martindeadman@mac.com'),
    ('riccardo@bsport.io'),
    ('mike.campin@gmail.com'),
    ('patricktenzing@gmail.com'),
    ('jesslt0609@hotmail.com'),
    ('joshbartoncoup@gmail.com'),
    ('shanel.1980@me.com'),
    ('palitta42@gmail.com'),
    ('benls.bls@gmail.com'),
    ('remee.baron@yahoo.com'),
    ('ja_blk@hotmail.com'),
    ('amelierkane@icloud.com'),
    ('fredmckie78@gmail.com'),
    ('georgia2002horn@gmail.com'),
    ('williamerdinc@gmail.com'),
    ('joehillier@btinternet.com'),
    ('hollywatton@hotmail.co.uk'),
    ('chelsey.bayliss1@icloud.com'),
    ('sophie_cox11@hotmail.co.uk'),
    ('glowe84@icloud.com'),
    ('annazammit22@gmail.com'),
    ('rachelnwebber50@googlemail.com'),
    ('tillylynk@icloud.com'),
    ('e.winter7@outlook.com'),
    ('dwogod@gmail.com'),
    ('kdella96@gmail.com'),
    ('devillierskeira@gmail.com'),
    ('efans98@gmail.com'),
    ('evaabest3@gmail.com'),
    ('collintabor@aol.com'),
    ('lukeacoxall93@gmail.com'),
    ('meganrenshaw1600@gmail.com'),
    ('cindyashworth@hotmail.co.uk'),
    ('perrygrant91@gmail.com'),
    ('emersondent125@gmail.com'),
    ('alex.puto090@gmail.com'),
    ('hannaheparker95@gmail.com'),
    ('gemcurnow@hotmail.com'),
    ('corbinanna510@gmail.com'),
    ('sianmedley@outlook.com'),
    ('rossfisher22@gmail.com'),
    ('david.geddes@co2target.co.uk'),
    ('abigailrwill@hotmail.co.uk'),
    ('elizeleveridge@hotmail.com'),
    ('chloe.grace.butterworth@gmail.com'),
    ('jadeluke16@hotmail.com'),
    ('fernkendrick1@gmail.com'),
    ('purplezxr@hotmail.com'),
    ('fackson@bsport.io'),
    ('geecoleby@googlemail.com'),
    ('olly4435@gmail.com'),
    ('alfierichardsuk@gmail.com'),
    ('opmail1@icloud.com'),
    ('lydia_503@hotmail.com'),
    ('annabelmiddleton12@icloud.com'),
    ('nataliegreen13@hotmail.co.uk'),
    ('helenemillican@gmail.com'),
    ('wscott1798@gmail.com'),
    ('kieranatodd@hotmail.com'),
    ('spencergrylls@gmail.com'),
    ('princesstwin@hotmail.com'),
    ('lucascamsey@gmail.com'),
    ('haenni_underhill@yahoo.com'),
    ('thomaswkarlsson@yahoo.se'),
    ('davi.0023@gmail.com'),
    ('elizabutchers@gmail.com'),
    ('olliestone88@gmail.com'),
    ('emmariejerome@icloud.com'),
    ('anguspollock12@gmail.com'),
    ('duncan.mcculloch@tsi.eu.com'),
    ('gareth.bracher@googlemail.com'),
    ('pearl.murphy@hotmail.co.uk'),
    ('isobel.as@gmail.com'),
    ('meganphelps92@gmail.com'),
    ('waldoramsay@gmail.com'),
    ('cormac.mcnicholas@gmail.com'),
    ('simon_mayne@icloud.com'),
    ('yvonnemacmorrow@hotmail.co.uk'),
    ('bartosz.czubacki@gmail.com'),
    ('elegalval@gmail.com'),
    ('elizzybee@protonmail.com'),
    ('hacrossen@icloud.com'),
    ('jamiehayball4@icloud.com'),
    ('emmajesshodgson@gmail.com'),
    ('maddychilton9@gmail.com'),
    ('sarah@doodleandpatch.com'),
    ('hattieclemas@gmail.com'),
    ('getrichhull@gmail.com'),
    ('ella_goodall@hotmail.co.uk'),
    ('emilycharl0tte17@gmail.com'),
    ('rjones@hillcroft.uk'),
    ('deilisinimeri@gmail.com'),
    ('sofiaoliveiraferreira@gmail.com'),
    ('carolinebeaumont@gmail.com'),
    ('shane.joseph.devlin@gmail.com'),
    ('aidanlindsaywood@gmail.com'),
    ('jenniecarr04@gmail.com'),
    ('ianfulton@btinternet.com'),
    ('alexnewman12@hotmail.com'),
    ('charbear2006@icloud.com'),
    ('lauraosey@googlemail.com'),
    ('jtotch@hotmail.com'),
    ('sfwestwater@hotmail.com'),
    ('julianreesthomas@live.co.uk'),
    ('joshuabatt042@gmail.com'),
    ('abifranklin102.af@gmail.com'),
    ('beckyhowlett702@hotmail.co.uk'),
    ('sbnh@btinternet.com'),
    ('tperrett@hotmail.com'),
    ('charlottem.dr@icloud.com'),
    ('tmcmeekin43@gmail.com'),
    ('bexta987@hotmail.co.uk'),
    ('lisa.langa@talktalk.net'),
    ('damonholmes@hotmail.co.uk'),
    ('lindsayjbreese@gmail.com'),
    ('alex.fedircic@yahoo.com'),
    ('lukecbrennan@gmail.com'),
    ('hwokersien@hotmail.com'),
    ('benji_123@msn.com'),
    ('danieljaveed@gmail.com'),
    ('charliebridge102@gmail.com'),
    ('hipkiss52@gmail.com'),
    ('emma3butchers@gmail.com'),
    ('rupert@yachthavens.com'),
    ('joannetreviss@gmail.com'),
    ('lizawalbanke@gmail.com'),
    ('emilyrosehamilton@gmail.com'),
    ('nathanjones1994@aol.com'),
    ('l_anderson@hotmail.co.uk'),
    ('ryanaustin413@gmail.com'),
    ('annatylek15@gmail.com'),
    ('carolineclough@icloud.com'),
    ('kaineread100@gmail.com'),
    ('ifmoyles1@gmail.com'),
    ('owenawalsh@hotmail.com'),
    ('alexwilliams1983@outlook.com'),
    ('davies.barnaby8@gmail.com'),
    ('bwbproducts@hotmail.com'),
    ('clairesaunders31@hotmail.co.uk'),
    ('bookishali5555@gmail.com'),
    ('humphrh@tcd.ie'),
    ('lewisrobbins1@googlemail.com'),
    ('shanel.1980@icloud.com'),
    ('jeevans40@hotmail.com'),
    ('jim.pickering05@gmail.com'),
    ('kanyeeasttm1@hotmail.com'),
    ('furandfetch@outlook.com'),
    ('harvey.baker1012@gmail.com'),
    ('florencewill18@gmail.com'),
    ('serdetelliot@hotmail.com'),
    ('joe8roberts@icloud.com'),
    ('maisiemccabe11@icloud.com'),
    ('antony.fitch@outlook.com'),
    ('excellingprofessionals@outlook.com'),
    ('sebastian.orzech@gmail.com'),
    ('zoey1roxanne@gmail.com'),
    ('laurabou18@gmail.com'),
    ('matthew.simpson436@gmail.com'),
    ('dgbinns@hotmail.co.uk'),
    ('luce.butterworth@gmail.com'),
    ('m.raynsford@outlook.com'),
    ('billycooper1992@outlook.com'),
    ('olly55_@live.com'),
    ('nicholaosborne@doctors.org.uk'),
    ('amy.partridge@hotmail.co.uk'),
    ('leilas-performers@live.co.uk'),
    ('borja@bsport.io'),
    ('info@1dmcworld.com'),
    ('harrietmiddleton@icloud.com'),
    ('anthonymholder@aol.com'),
    ('philipbutchers@gmail.com'),
    ('lucyharrison246@gmail.com'),
    ('mel@melhoven.com'),
    ('bailey66j@gmail.com'),
    ('fim105@googlemail.com'),
    ('nathanmartin8@outlook.com'),
    ('gonggoddess33@gmail.com'),
    ('edwardnewton70@yahoo.co.uk'),
    ('rachel-craig@hotmail.com'),
    ('bailey1999foreman@outlook.com'),
    ('tomh@saunabox.co.uk'),
    ('gregoryldavies@yahoo.co.uk'),
    ('richardcolbourne68@gmail.com'),
    ('movewithgrace.wellness@gmail.com'),
    ('benholt503@gmail.com'),
    ('laura.szehofner@yahoo.co.uk'),
    ('champanluca7@gmail.com'),
    ('wpalmerbusiness@gmail.com'),
    ('jordonwalbanke1@gmail.com'),
    ('meganhodgson2014@outlook.com'),
    ('caro.peel@gmail.com'),
    ('philipbendon@icloud.com'),
    ('chrisrg9@gmail.com')
  ) AS t(email_address)
) AS emails
WHERE NOT EXISTS (
  SELECT 1 FROM public.password_reset_email_log 
  WHERE LOWER(password_reset_email_log.email) = emails.email_address
);